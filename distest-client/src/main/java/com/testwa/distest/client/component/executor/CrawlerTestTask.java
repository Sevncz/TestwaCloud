package com.testwa.distest.client.component.executor;import com.testwa.core.cmd.RemoteRunCommand;import com.testwa.distest.client.ApplicationContextUtil;import com.testwa.distest.client.component.appium.manager.AppiumManager;import com.testwa.distest.client.component.appium.pool.AppiumManagerPool;import com.testwa.distest.client.component.executor.worker.AndroidExecutorFactory;import com.testwa.distest.client.component.executor.worker.CrawlerAbstractExecutor;import com.testwa.distest.client.service.GrpcClientService;import lombok.extern.slf4j.Slf4j;import java.util.concurrent.TimeUnit;@Slf4jpublic class CrawlerTestTask extends AbstractTestTask{    private RemoteRunCommand cmd;    private CrawlerAbstractExecutor executor;    private AppiumManagerPool pool;    private AppiumManager manager;    private TestTaskListener listener;    public CrawlerTestTask(RemoteRunCommand cmd, TestTaskListener listener){        this.cmd = cmd;        this.listener = listener;    }    public void start() {        pool = (AppiumManagerPool) ApplicationContextUtil.getBean("appiumManagerPool");        GrpcClientService grpcClientService = (GrpcClientService) ApplicationContextUtil.getBean("grpcClientService");        manager = pool.getManager();        String appiumLogPath = manager.getAppiumlogPath();        try {            TimeUnit.SECONDS.sleep(5);        } catch (InterruptedException e) {            e.printStackTrace();        }        log.info("获得Appium路径 - {}", appiumLogPath);        if(manager.getAppiumService().isRunning()){            try {                String appiumUrl = manager.getAppiumService().getUrl().toString();                log.info("获得appiumUrl - {}", appiumUrl);                AndroidExecutorFactory executorFactory = new AndroidExecutorFactory();                executor = executorFactory.getCrawlerTask(cmd);                executor.init(appiumUrl, cmd, listener);                log.info("init 完成");                AppDownloadExecutorHandler appHander = new AppDownloadExecutorHandler();                ExecutorHandler handler = new ExecutorHandler();                appHander.setHandler(handler);                appHander.handleRequest(executor);                grpcClientService.missionComplete(cmd.getTaskCode(), cmd.getDeviceId());            } catch (Exception e){                log.error("{} 任务执行错误", cmd.getDeviceId(), e);                grpcClientService.gameover(cmd.getTaskCode(), cmd.getDeviceId(), e.getMessage());            } finally {                grpcClientService.appiumLogUpload(cmd.getTaskCode(), cmd.getDeviceId(), appiumLogPath);            }        }else{            log.error("Appium 启动失败");            grpcClientService.gameover(cmd.getTaskCode(), cmd.getDeviceId(), "Appium 启动失败");        }        try {            pool.release(manager);        } catch (Exception e) {            log.warn("appium release error.... .... ");        }        listener.taskFinish();    }    public void kill() {        log.info("设备 {} 测试任务被停止", cmd.getDeviceId());        if (executor != null) {            executor.stop();        }        if(pool != null){            try {                pool.release(manager);            } catch (Exception e) {                log.warn("appium release error.... .... ");            }        }    }}