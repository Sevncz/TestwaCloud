package com.testwa.distest.client.component.minicap.ios;import com.testwa.core.shell.UTF8CommonExecs;import com.testwa.distest.client.component.appium.utils.Config;import com.testwa.distest.client.component.minicap.MinicapServer;import com.testwa.distest.client.component.port.MinicapPortProvider;import lombok.extern.slf4j.Slf4j;import org.apache.commons.exec.CommandLine;import org.apache.commons.lang3.StringUtils;import java.nio.file.Path;import java.nio.file.Paths;import java.util.concurrent.TimeUnit;import static org.apache.commons.exec.ExecuteWatchdog.INFINITE_TIMEOUT;/** * @Program: distest * @Description: ios minicap * @Author: wen * @Create: 2018-06-20 10:40 **/@Slf4jpublic class IMinicapServer extends MinicapServer {    private String RESOLUTION = "400x600";    private int PORT;    private String uuid;    private String resourcePath;    private Path ios_minicap_file;    private UTF8CommonExecs execs;    public IMinicapServer(String uuid) {        this.uuid = uuid;        this.resourcePath = Config.getString("distest.agent.resources");        this.ios_minicap_file = Paths.get(this.resourcePath,"ios-minicap", "ios_minicap");        this.PORT = MinicapPortProvider.pullPort();    }    @Override    public void start() {        CommandLine commandLine = getMinicapCommand();        try {            execs = new UTF8CommonExecs(commandLine);            execs.setTimeout(INFINITE_TIMEOUT);            execs.asyncexec();        } catch (Exception e) {            String out = execs.getOutput();            String error = execs.getError();            log.error("uuid: {}  out: {}  error: {}", uuid, out, error);        }        int tryTime = 50;        while(tryTime > 0) {            try {                TimeUnit.SECONDS.sleep(1);                String out = execs.getOutput();                if(StringUtils.isNotBlank(out)){                    log.info(out);                    break;                }            } catch (Exception e) {                e.printStackTrace();            }            tryTime--;        }    }    @Override    public void restart() {        if(execs != null) {            execs.destroy();        }        start();    }    @Override    public void restart(float scale, int rotate) {        restart();    }    private CommandLine getMinicapCommand() {        CommandLine commandLine = new CommandLine(this.ios_minicap_file.toString());        commandLine.addArgument("-uuid");        commandLine.addArgument(this.uuid);        commandLine.addArgument("--port");        commandLine.addArgument(String.valueOf(this.PORT));        commandLine.addArgument("--resolution");        commandLine.addArgument(this.RESOLUTION);        return commandLine;    }    @Override    public void stop() {        if(execs != null){            execs.destroy();        }    }    @Override    public int getPort() {        return this.PORT;    }}