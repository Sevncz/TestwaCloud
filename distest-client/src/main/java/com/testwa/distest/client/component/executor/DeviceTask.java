package com.testwa.distest.client.component.executor;import com.testwa.core.cmd.RemoteRunCommand;import com.testwa.distest.client.ApplicationContextUtil;import com.testwa.distest.client.component.appium.AppiumManager;import com.testwa.distest.client.component.appium.pool.AppiumManagerPool;import com.testwa.distest.client.component.appium.utils.Config;import com.testwa.distest.client.exception.DownloadFailException;import com.testwa.distest.client.service.GrpcClientService;import lombok.extern.slf4j.Slf4j;import java.io.IOException;import java.util.ArrayList;import java.util.List;@Slf4jpublic class DeviceTask {    private List<DeviceTaskListener> listenerList = new ArrayList<>();    private Thread taskInitialThread;    private RemoteRunCommand cmd;    private PythonExecutor executor;    public DeviceTask(RemoteRunCommand cmd){        this.cmd = cmd;    }    public void start() {        log.info("设备 {} 开始测试任务", cmd.getDeviceId());        AppiumManagerPool pool = (AppiumManagerPool) ApplicationContextUtil.getBean("appiumManagerPool");        GrpcClientService grpcClientService = (GrpcClientService) ApplicationContextUtil.getBean("grpcClientService");        String distestApiWeb = Config.getString("distest.api.web");        String distestApiName = Config.getString("distest.api.name");        taskInitialThread = new Thread(new StartInitial(grpcClientService, pool, distestApiWeb, distestApiName));        taskInitialThread.setDaemon(false);        taskInitialThread.start();    }    class StartInitial implements Runnable {        private GrpcClientService grpcClientService;        private AppiumManagerPool pool;        private String distestApiWeb;        private String distestApiName;        public StartInitial(GrpcClientService grpcClientService, AppiumManagerPool pool, String distestApiWeb, String distestApiName) {            this.grpcClientService = grpcClientService;            this.pool = pool;            this.distestApiWeb = distestApiWeb;            this.distestApiName = distestApiName;        }        public void run() {            final AppiumManager manager = pool.getManager();            String appiumLogPath = manager.getAppiumlogPath();            if(manager.getAppiumService().isRunning()){                try {                    String appiumUrl = manager.getAppiumService().getUrl().toString();                    executor = ProxyFactory.getPyExecutorInstance(PythonExecutor.class, cmd);                    executor.init(distestApiWeb, distestApiName, appiumUrl, cmd);                    onStartup(true);                    AppDownloadExecutorHandler appHander = new AppDownloadExecutorHandler();                    ScriptDownloadExecutorHandler scriptHander = new ScriptDownloadExecutorHandler();                    PythonExecutorHandler pythonHander = new PythonExecutorHandler();                    appHander.setHandler(scriptHander);                    scriptHander.setHandler(pythonHander);                    appHander.handleRequest(executor);                    grpcClientService.missionComplete(cmd.getExeId(), cmd.getDeviceId());                } catch (DownloadFailException | IOException e){                    onStartup(false);                    log.error("{} 任务执行错误", cmd.getDeviceId(), e);                    grpcClientService.gameover(cmd.getExeId(), cmd.getDeviceId(), e.getMessage());                } finally {                    grpcClientService.appiumLogUpload(cmd.getExeId(), cmd.getDeviceId(), appiumLogPath);                }            }else{                log.error("Appium 启动失败");                grpcClientService.gameover(cmd.getExeId(), cmd.getDeviceId(), "Appium 启动失败");            }            pool.release(manager);            onComplete();        }    }    public void kill() {        log.info("设备 {} 测试任务被停止", cmd.getDeviceId());        if (executor != null) {            executor.stop();            onCancel();        }    }    public void addEventListener(DeviceTaskListener listener) {        if (listener != null) {            this.listenerList.add(listener);        }    }    private void onStartup(boolean success) {        for (DeviceTaskListener listener : listenerList) {            listener.onStartup(this, success);        }    }    private void onComplete() {        log.info("设备 {} 完成测试任务", cmd.getDeviceId());        for (DeviceTaskListener listener : listenerList) {            listener.onComplete(this);        }    }    private void onCancel() {        for (DeviceTaskListener listener : listenerList) {            listener.onCancel(this);        }    }}