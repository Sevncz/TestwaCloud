package com.testwa.distest.client.component.executor.worker;import com.github.cosysoft.device.android.AndroidDevice;import com.github.cosysoft.device.android.impl.AndroidDeviceStore;import com.github.cosysoft.device.android.impl.DefaultAndroidApp;import com.testwa.core.cmd.AppInfo;import com.testwa.core.cmd.KeyCode;import com.testwa.core.cmd.RemoteRunCommand;import com.testwa.core.utils.TimeUtil;import com.testwa.distest.client.ApplicationContextUtil;import com.testwa.distest.client.android.ADBCommandUtils;import com.testwa.distest.client.android.ADBTools;import com.testwa.distest.client.android.JadbDeviceManager;import com.testwa.distest.client.component.Constant;import com.testwa.distest.client.component.FlowResult;import com.testwa.distest.client.component.StepResult;import com.testwa.distest.client.component.appium.utils.Config;import com.testwa.distest.client.component.executor.task.TestTaskListener;import com.testwa.distest.client.component.executor.uiautomator2.Ui2Command;import com.testwa.distest.client.component.executor.uiautomator2.Bounds;import com.testwa.distest.client.component.executor.uiautomator2.Ui2Server;import com.testwa.distest.client.component.logcat.DLogger;import com.testwa.distest.client.component.minicap.ScreenAndroidProjection;import com.testwa.distest.client.config.CacheProperty;import com.testwa.distest.client.device.driver.IDeviceRemoteControlDriverCapabilities;import com.testwa.distest.client.device.listener.AndroidComponentServiceRunningListener;import com.testwa.distest.client.device.remote.DeivceRemoteApiClient;import com.testwa.distest.client.download.Downloader;import com.testwa.distest.client.exception.*;import com.testwa.distest.client.model.UserInfo;import com.testwa.distest.client.service.GrpcClientService;import io.rpc.testwa.task.FileUploadRequest;import io.rpc.testwa.task.StepRequest;import lombok.extern.slf4j.Slf4j;import org.apache.commons.lang3.StringUtils;import java.io.File;import java.io.IOException;import java.nio.file.Files;import java.nio.file.Path;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;import java.util.concurrent.*;/** * @Program: distest * @Description: * @Author: wen * @Create: 2018-05-15 14:28 **/@Slf4jpublic abstract class AbstractExecutor {    public static final String TESTWA_PWD = "testwa123";    protected final Path logcatTempFile = Paths.get(Constant.localLogcatPath, Thread.currentThread().getId() + ".txt");    protected final Path actionScreenTempFile = Paths.get(Constant.localActionScreenPath);    protected Ui2Server ui2Server;    protected DLogger dLogger;    protected GrpcClientService grpcClientService;    protected RemoteRunCommand cmd;    protected String distestApiWeb;    protected AppInfo appInfo;    protected String deviceId;    protected Downloader downloader;    protected Integer cpukel;    protected AndroidDevice device;    protected boolean install;    protected String appLocalPath;    protected DefaultAndroidApp androidApp;    private FlowResult startFlow;    private Integer lastFps;    protected final ScheduledExecutorService scheduledExecutor = Executors.newScheduledThreadPool(15);    private Ui2Command ui2Command;    private ScheduledFuture performFuture;    private ScheduledFuture runningAlterFuture;    private Map<String, ScheduledFuture> installFutures = new HashMap<>();    private Long installStart = null;    private TestTaskListener listener;    private AndroidComponentServiceRunningListener androidComponentListener;    private ScreenAndroidProjection screenProjection;    private DeivceRemoteApiClient api;    public String screenshoot() {        if(this.androidComponentListener != null) {            byte[] frame = this.androidComponentListener.takeFrame();            if(frame != null) {                try {                    Path screenPath = Paths.get(actionScreenTempFile.toString(), TimeUtil.getTimestampLong() + ".jpg");                    Files.write(screenPath, frame);                    return screenPath.toString();                } catch (IOException e) {                    e.printStackTrace();                    log.error("[{}] 截图失败", device.getDeviceInfo().getSerial());                }            }        }        return null;    }    public void screenshoot(String screenFile) {        if(this.androidComponentListener != null) {            byte[] frame = this.androidComponentListener.takeFrame();            if(frame != null) {                try {                    Path screenPath = Paths.get(screenFile);                    Files.write(screenPath, frame);                } catch (IOException e) {                    e.printStackTrace();                    log.error("[{}] 截图失败", device.getDeviceInfo().getSerial());                }            }        }    }    /**     * 初始化     */    public void init(RemoteRunCommand cmd, TestTaskListener listener) {        this.grpcClientService = (GrpcClientService) ApplicationContextUtil.getBean("grpcClientService");        this.listener = listener;        this.cmd = cmd;        this.distestApiWeb = Config.getString("distest.api.web");        this.appInfo = cmd.getAppInfo();        this.deviceId = cmd.getDeviceId();        this.downloader = new Downloader();        this.device = AndroidDeviceStore.getInstance().getDeviceBySerial(deviceId);        this.install = cmd.getInstall();        this.cpukel = ADBCommandUtils.getCpuKel(deviceId);        try {            log.info("logcat 临时文件: {}", logcatTempFile.toString());            Files.deleteIfExists(logcatTempFile);            Files.createFile(logcatTempFile);        } catch (IOException e) {        }        this.api = ApplicationContextUtil.getBean(DeivceRemoteApiClient.class);        this.androidComponentListener = new AndroidComponentServiceRunningListener(cmd.getDeviceId(), api);        this.screenProjection = new ScreenAndroidProjection(cmd.getDeviceId(), CacheProperty.getResourcePath(), this.androidComponentListener);        this.screenProjection.setRotate(0);        this.screenProjection.setQuality(25);        this.screenProjection.start();    }    public void destory() {        if(this.screenProjection != null) {            this.screenProjection.close();        }    }    /**     * 下载app     */    public void downloadApp(){        log.info("{} 开始下载app {}", device.getName(), appInfo.getDisplayName());        String appUrl = String.format("http://%s/app/%s", distestApiWeb, appInfo.getPath());        this.appLocalPath = Constant.localAppPath + File.separator + appInfo.getMd5() + File.separator + appInfo.getFileAliasName();        // 检查是否有和该app md5一致的        StepResult result = new StepResult(StepRequest.StepAction.downloadApp);        Long start = System.currentTimeMillis();        try {            downloader.start(appUrl, appLocalPath);        } catch (DownloadFailException | IOException e) {            result.setStatus(StepRequest.StepStatus.FAIL);            result.setErrormsg(e.getMessage());        }finally {            Long end = System.currentTimeMillis();            result.setTotalTime(end - start);        }        sendStepRequest(result);        androidApp = new DefaultAndroidApp(new File(appLocalPath));    }    /**     * 任务启动入口     */    public abstract void start();    /**     * 安装APP     */    public void installApp() throws InstallAppException {        ui2ServerStart();        ADBCommandUtils.unlockWindow(deviceId);        ADBCommandUtils.inputCode(deviceId, KeyCode.KEYCODE_HOME);        if(ADBCommandUtils.isInstalledBasepackage(deviceId, androidApp.getBasePackage())){            ADBCommandUtils.uninstallApp(deviceId, androidApp.getBasePackage());        }        ui2Command.startInstallCheck(deviceId);        log.info("{} 开始安装应用", device.getName());        StepResult result = ADBCommandUtils.installApp(deviceId, appLocalPath);        Long installEnd = System.currentTimeMillis();        if(installStart != null) {            result.setTotalTime(installEnd - installStart);        }        sleep(10);        ui2Command.stopInstallCheck();        sendStepRequest(result);        if(StepRequest.StepStatus.FAIL.equals(result.getStatus())){            throw new InstallAppException(result.getErrormsg());        }    }    /**     * 启动APP     */    public void launch() throws LaunchAppException {        log.info("{} 开始启动应用", device.getName());        String imgBefore = screenshoot();        String imgAfter = null;        StepResult result = null;        ui2Command.startProcessRunningAlter();        int time = 60;        while(time > 0) {            result = ADBCommandUtils.launcherApp(deviceId, appLocalPath);            String pid = ADBCommandUtils.getPid(deviceId,appInfo.getPackageName());            log.info("{} 检查应用 {} 是否启动, pid = {}", device.getName(), appInfo.getPackageName(), pid);            if(StringUtils.isNotBlank(pid)) {                // 等2秒启动完成                try {                    TimeUnit.SECONDS.sleep(2);                } catch (InterruptedException e) {                }                break;            }            try {                TimeUnit.SECONDS.sleep(1);            } catch (InterruptedException e) {            }            time--;        }        imgAfter = screenshoot();        sendStepRequest(result, imgBefore, imgAfter);        if(StepRequest.StepStatus.FAIL.equals(result.getStatus())){            log.info("启动失败");            throw new LaunchAppException(result.getErrormsg());        }        // 暂停10秒，让程序处理一下权限弹框        sleep(10);//        if(className.contains("CompatibilityAndroidExecutor")) {            // 完成之后关闭 ui2server//            this.ui2Server.close();//        }        this.ui2ServerStop();    }    /**     * 操作设备     */    public abstract void run() throws TestcaseRunningException;    /**     * 卸载APP     */    public void uninstallApp() throws UninstallAppException {        log.info("{} 开始卸载应用", device.getName());        StepResult result = ADBCommandUtils.uninstallApp(deviceId, androidApp.getBasePackage());        sendStepRequest(result);        if(StepRequest.StepStatus.FAIL.equals(result.getStatus())){            throw new UninstallAppException(result.getErrormsg());        }    }    /**     * 执行完成     */    public void complete() {        // 上传logcat        this.grpcClientService.logcatFileUpload(logcatTempFile, cmd.getTaskCode(), deviceId);        // 上传完成步骤        StepRequest request = StepRequest.newBuilder()                .setToken(UserInfo.token)                .setTaskCode(cmd.getTaskCode())                .setDeviceId(deviceId)                .setAction(StepRequest.StepAction.complete)                .setStatus(StepRequest.StepStatus.SUCCESS)                .build();        grpcClientService.saveStep(request);        // 上报服务器，任务完成        grpcClientService.missionComplete(cmd.getTaskCode(), cmd.getDeviceId());    }    /**     * @Description: 关闭工作线程，打扫线程     * @Param: []     * @Return: void     * @Author wen     * @Date 2018/9/10 17:38     */    protected void cleanThread() {        listener.taskFinish();        log.info("关闭ffmpeg.....");        loggerStop();        ui2ServerStop();        uploadVideo();    }    protected void uploadVideo() {        // 上传测试录像        String videoOutputFile = listener.getVideoFile();        if(StringUtils.isNotBlank(videoOutputFile)) {            Path videoPath = Paths.get(videoOutputFile);            log.info("上传MP4文件, 设备：{}，路径：{}", device.getName(), videoOutputFile);            grpcClientService.largeFileUpload(videoPath, videoPath.getParent().toString(), FileUploadRequest.Type.video, this.cmd.getTaskCode(), this.deviceId);            log.info("上传MP4文件完成, 设备：{} ", device.getName());            try {                log.info("删除MP4文件 {}", videoOutputFile);                Files.deleteIfExists(videoPath);            } catch (IOException e) {                log.warn("删除MP4文件失败", e);            }        }    }    /**     * 停止任务     */    public abstract void stop();    void startRecodPerformance() {        int initialDelay = 0;        int period = 1;        // 性能抓取任务参数初始化        performFuture = scheduledExecutor.scheduleWithFixedDelay(getPerformanceTask, initialDelay, period, TimeUnit.SECONDS);    }    void stopRecodPerformance() {        performFuture.cancel(true);    }    private Runnable getPerformanceTask = new Runnable() {        @Override        public void run() {            try {                String pid = ADBCommandUtils.getPid(deviceId, androidApp.getBasePackage());                if(startFlow == null){                    startFlow = ADBCommandUtils.getFlow(deviceId, pid);                }                Double cpu = null;                if(cpukel == null) {                    log.error("设备 {} 获取cpu指标错误，cpu数量为空", device.getName());                    cpukel = ADBCommandUtils.getCpuKel(deviceId);                }                if(cpukel != null) {                    try {                        cpu = ADBCommandUtils.cpuRate(deviceId, pid, cpukel);                    } catch (Exception e) {                    }finally {                        if(cpu == null) {                            cpu = 0.0;                        }                    }                }                // 获得累计流量                FlowResult[] flows = ADBCommandUtils.flow(deviceId, pid, startFlow); // kb                startFlow = flows[0];                FlowResult resultFlow = flows[1];                Integer mem = ADBCommandUtils.ram(deviceId, androidApp.getBasePackage()); // kb                if(mem == null) {                    mem = 0;                }                Integer bat = ADBCommandUtils.battery(deviceId);                if(bat == null) {                    bat = 0;                }                Integer fps = ADBCommandUtils.fps(deviceId, androidApp.getBasePackage());                if(fps == null){                    if (lastFps != null){                        fps = lastFps;                    }else{                        fps = 0;                    }                }else{                    lastFps = fps;                }                log.debug("ram: {}, bat: {}, cpu: {}, fps: {} flow: {}", mem, bat, cpu, fps, resultFlow);                grpcClientService.savePreformance(cpu, mem, bat, fps, resultFlow, cmd.getTaskCode(), deviceId);            } catch (Exception e) {                log.error("设备 {} 获取指标异常", device.getName(), e);            }        }    };    /**     *@Description: 启动logcat，并记录     *@Param: []     *@Return: void     *@Author: wen     *@Date: 2018/5/14     */    void loggerStart() {        this.dLogger = new DLogger(deviceId);        this.dLogger.setLogFile(logcatTempFile);        this.dLogger.start();    }    void loggerStop() {        if(this.dLogger != null){            this.dLogger.close();        }    }    /**     *@Description: 启动一个uiautomator2     *@Param:     *@Return:     *@Author: wen     *@Date: 2018/6/6     */    void ui2ServerStart() {        if(ui2Server == null) {            ui2Server = new Ui2Server(deviceId);            ui2Server.start();            ui2Command = new Ui2Command(ui2Server.getUiServerPort());        }else{            ui2Server.restart();        }    }    void ui2ServerStop() {        if(this.ui2Server != null){            log.warn("{} Uiautomator2 server stop!", device.getName());            ui2Command.stopProcessRunningAlter();            sleep(5);            ui2Server.close();        }    }    void sleep(int second) {        try {            TimeUnit.SECONDS.sleep(second);        } catch (InterruptedException e) {        }    }    void sendStepRequest(StepResult result) {        StepRequest request = StepRequest.newBuilder()                .setToken(UserInfo.token)                .setTaskCode(cmd.getTaskCode())                .setDeviceId(deviceId)                .setAction(result.getAction())                .setStatus(result.getStatus())                .setRuntime(result.getTotalTime())                .setErrormsg(result.getErrormsg())                .setTimestamp(System.currentTimeMillis())                .build();        grpcClientService.saveStep(request);    }    void sendStepRequest(StepResult result, String imgBefore, String imgAfter) {        if(StringUtils.isAnyBlank(imgBefore, imgAfter)) {            log.info("启动截图为空: before {} after {}", imgBefore, imgAfter);            // 上传步骤            StepRequest request = StepRequest.newBuilder()                    .setToken(UserInfo.token)                    .setTaskCode(cmd.getTaskCode())                    .setDeviceId(deviceId)                    .setAction(result.getAction())                    .setStatus(result.getStatus())                    .setRuntime(result.getTotalTime())                    .setErrormsg(result.getErrormsg())                    .setTimestamp(System.currentTimeMillis())                    .build();            grpcClientService.saveStep(request);            return;        }        Path imgBeforePath = Paths.get(imgBefore);        Path imgAfterPath = Paths.get(imgAfter);        // 上传截图        grpcClientService.imgUpload(cmd.getTaskCode(), imgBefore, deviceId);        grpcClientService.imgUpload(cmd.getTaskCode(), imgAfter, deviceId);        // 上传步骤        StepRequest request = StepRequest.newBuilder()                .setToken(UserInfo.token)                .setTaskCode(cmd.getTaskCode())                .setDeviceId(deviceId)                .setAction(result.getAction())                .setStatus(result.getStatus())                .setRuntime(result.getTotalTime())                .setErrormsg(result.getErrormsg())                .setTimestamp(System.currentTimeMillis())                .setImgBefore(imgBeforePath.getFileName().toString())                .setImg(imgAfterPath.getFileName().toString())                .build();        grpcClientService.saveStep(request);    }}