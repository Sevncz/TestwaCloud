package com.testwa.distest.client.download;import com.testwa.distest.client.exception.DownloadFailException;import lombok.extern.slf4j.Slf4j;import java.io.FileOutputStream;import java.io.IOException;import java.net.HttpURLConnection;import java.net.URL;import java.nio.channels.Channels;import java.nio.channels.FileChannel;import java.nio.channels.FileLock;import java.nio.channels.ReadableByteChannel;import java.nio.file.Files;import java.nio.file.Path;import java.nio.file.Paths;import java.util.Collections;import java.util.HashSet;import java.util.Set;/** * @Program: distest * @Description: 文件下载器 * @Author: wen * @Create: 2018-04-19 11:30 **/@Slf4jpublic class Downloader implements RBCWrapperDelegate {    private static final Set<String> LOCK_HELD = Collections.synchronizedSet(new HashSet<String>());    public void start(String fromUrl, String savepath) throws DownloadFailException, IOException {        while(!LOCK_HELD.add(fromUrl)){            try {                log.info("wating........");                Thread.sleep(1000);            } catch (InterruptedException e) {                e.printStackTrace();            }        }        ReadableByteChannel rbc = null;        try{            URL website = new URL(fromUrl);            Path toLocal = Paths.get(savepath);            if(!Files.exists(toLocal.getParent())){                Files.createDirectories(toLocal.getParent());            }else{                log.debug("File exists!  " + savepath);                int fileSize = contentLength(website);                if(Files.exists(toLocal) && Files.size(toLocal) == fileSize){                    log.info("To local file {} exists, return !", savepath);                    return;                }            }            FileChannel channel = new FileOutputStream(savepath).getChannel();            log.info("downloading........");            rbc = new RBCWrapper(Channels.newChannel(website.openStream()), contentLength(website), this);            channel.transferFrom(rbc, 0, Long.MAX_VALUE);        } catch (Exception e) {            log.error("Download file {} error!", fromUrl);            throw new DownloadFailException(e.getMessage());        } finally {            if(rbc != null){                rbc.close();            }            LOCK_HELD.remove(fromUrl);        }    }    public void rbcProgressCallback(RBCWrapper rbc, double progress) {        log.info(String.format("download progress %d bytes received, %.02f%%", rbc.getReadSoFar(), progress));    }    private int contentLength(URL url) {        HttpURLConnection connection;        int contentLength = -1;        try {            HttpURLConnection.setFollowRedirects(false);            connection = (HttpURLConnection) url.openConnection();            connection.setRequestMethod("HEAD");            contentLength = connection.getContentLength();        } catch (Exception e) {        }        return contentLength;    }}