package com.testwa.distest.client.component.minicap;import com.testwa.core.shell.UTF8CommonExecs;import com.testwa.distest.client.command.CommonProcessListener;import com.testwa.distest.client.component.appium.utils.Config;import com.testwa.distest.client.component.port.MinicapPortProvider;import com.testwa.distest.client.ios.IOSDeviceUtil;import com.testwa.distest.client.ios.IOSPhysicalSize;import lombok.extern.slf4j.Slf4j;import org.apache.commons.exec.CommandLine;import org.zeroturnaround.exec.ProcessExecutor;import org.zeroturnaround.exec.ProcessResult;import org.zeroturnaround.exec.stop.DestroyProcessStopper;import org.zeroturnaround.exec.stream.LogOutputStream;import java.io.IOException;import java.nio.file.Path;import java.nio.file.Paths;import java.util.ArrayList;import java.util.List;import java.util.concurrent.Future;/** * @Program: distest * @Description: ios minicap * @Author: wen * @Create: 2018-06-20 10:40 **/@Slf4jpublic class MinicapIOSServer{    private String resolution;    private Integer port;    private String udid;    private String resourcePath;    private Path iosMinicapFile;    private Future<ProcessResult> future;    private CommonProcessListener processListener;    public MinicapIOSServer(String udid) {        this.udid = udid;        IOSPhysicalSize size = IOSDeviceUtil.getSize(udid);        if(size != null) {            this.resolution = String.format("%dx%d", size.getPhsicalWidth(), size.getPhsicalHeight());        }else{            this.resolution =  "750x1334";        }        this.resourcePath = Config.getString("distest.agent.resources");        this.iosMinicapFile = Paths.get(this.resourcePath,"ios-minicap", "ios_minicap");        this.processListener = new CommonProcessListener(this.getClass().getName());    }    /**     * 是否运行     * @return true 已运行 false 未运行     */    public boolean isRunning() {        if(future != null) {            if(future.isCancelled()){                return false;            }            if(future.isDone()){                return false;            }            return true;        }else{            return false;        }    }    public void close() {        if(future != null) {            if(processListener.getProcess() != null) {                DestroyProcessStopper.INSTANCE.stop(processListener.getProcess());            }        }        MinicapPortProvider.pushPort(this.port);    }    public void restart() {        close();        start();    }    public synchronized void start() {        this.port = MinicapPortProvider.pullPort();        List<String> commandLine = getMinicapCommandList(this.port);        log.info("拉起 ios Minicap 服务 shellCommand: {}", commandLine.toString().replace(",", ""));        try {            future = new ProcessExecutor()                    .command(commandLine)                    .redirectOutput(new LogOutputStream() {                        @Override                        protected void processLine(String line) {                            log.debug(line);                        }                    }).listener(processListener)                    .start().getFuture();        } catch (IOException e) {            e.printStackTrace();        }    }    private List<String> getMinicapCommandList(int port) {        List<String> command = new ArrayList<>();        command.add(this.iosMinicapFile.toString());        command.add("--udid");        command.add(this.udid);        command.add("--port");        command.add(String.valueOf(port));        command.add("--resolution");        command.add(this.resolution);        return command;    }    public int getPort() {        return this.port;    }}